<?php
/**
 * @category    Joomla component
 * @package     THM_Organizer
 * @subpackage  com_thm_organizer.admin
 * @name        THM_OrganizerModelSchedule
 * @author      James Antrim, <james.antrim@nm.thm.de>
 * @copyright   2016 TH Mittelhessen
 * @license     GNU GPL v.2
 * @link        www.thm.de
 */
defined('_JEXEC') or die;
JTable::addIncludePath(JPATH_BASE . '/administrator/components/com_thm_organizer/tables');
/** @noinspection PhpIncludeInspection */
require_once JPATH_ROOT . '/media/com_thm_organizer/helpers/xml/schedule.php';
require_once JPATH_ROOT . '/media/com_thm_organizer/helpers/json/schedule.php';
require_once JPATH_ROOT . '/media/com_thm_organizer/helpers/json/old_schedule.php';

/**
 * Class enapsulating data abstraction and business logic for xml schedules
 * generated by Untis software.
 *
 * @category    Joomla.Component.Admin
 * @package     thm_organizer
 * @subpackage  com_thm_organizer.admin
 */
class THM_OrganizerModelSchedule extends JModelLegacy
{
	/**
	 * JSON Object modeling the schedule (old format)
	 *
	 * @var object
	 */
	public $schedule = null;

	/**
	 * JSON Object modeling the schedule (old format)
	 *
	 * @var object
	 */
	public $newSchedule = null;

	/**
	 * Activates the selected schedule
	 *
	 * @param   int $scheduleID the explicit id of the schedule to activate
	 *
	 * @return  true on success, otherwise false
	 */
	public function activate($scheduleID = 0)
	{
		$save   = false;
		$active = $this->getScheduleRow($save);
		if (empty($active) OR empty($active->id) OR !empty($active->active))
		{
			return true;
		}

		$reference = $this->getScheduleRow($save, $active->departmentID, $active->planningPeriodID);
		if (empty($reference) OR empty($reference->id))
		{
			$jsonModel  = new THM_OrganizerModelJSONSchedule($this->newSchedule);
			$jsonModel->save();
			$active->set('active', 1);
			$active->store();
			return true;
		}

		$oldJsonModel  = new THM_OrganizerModelOldJSONSchedule;
		$oldRefSuccess = $oldJsonModel->setReference($reference, $active);

		if (!$oldRefSuccess)
		{
			return false;
		}

		// Free up memory
		unset($oldJsonModel);

		$jsonModel  = new THM_OrganizerModelJSONSchedule;
		return $jsonModel->setReference($reference, $active);
	}

	/**
	 * Checks if the first selected schedule is active
	 *
	 * @return boolean true if the schedule is active otherwise false
	 */
	public function checkIfActive()
	{
		$scheduleIDs = JFactory::getApplication()->input->get('cid', array(), 'array');
		if (!empty($scheduleIDs))
		{
			$scheduleID = $scheduleIDs[0];
			$schedule   = JTable::getInstance('schedules', 'thm_organizerTable');
			$schedule->load($scheduleID);

			return $schedule->active;
		}

		return false;
	}

	/**
	 * Activates the selected schedule
	 *
	 * @param   int $scheduleID the explicit id of the schedule to activate
	 *
	 * @return  true on success, otherwise false
	 */
	public function deactivate($scheduleID)
	{
		if (empty($scheduleID))
		{
			return false;
		}

		$scheduleRow    = JTable::getInstance('schedules', 'thm_organizerTable');
		$scheduleExists = $scheduleRow->load($scheduleID);
		if (!$scheduleExists)
		{
			return false;
		}

		$this->_db->transactionStart();
		$scheduleRow->active = 0;
		$success             = $scheduleRow->store();
		if ($success)
		{
			$this->_db->transactionCommit();

			return true;
		}
		else
		{
			$this->_db->transactionRollback();

			return false;
		}
	}

	/**
	 * Deletes the selected schedules
	 *
	 * @return boolean true on successful deletion of all selected schedules
	 *                 otherwise false
	 */
	public function delete()
	{
		$this->_db->transactionStart();
		$scheduleIDs = JFactory::getApplication()->input->get('cid', array(), 'array');
		foreach ($scheduleIDs as $scheduleID)
		{
			try
			{
				$success = $this->deleteSingle($scheduleID);
			}
			catch (Exception $exception)
			{
				JFactory::getApplication()->enqueueMessage(JText::_("COM_THM_ORGANIZER_MESSAGE_DATABASE_ERROR"), 'error');
				$this->_db->transactionRollback();

				return false;
			}

			if (!$success)
			{
				$this->_db->transactionRollback();

				return false;
			}
		}
		$this->_db->transactionCommit();

		return true;
	}

	/**
	 * Deletes a single schedule
	 *
	 * @param   int $scheduleID the id of the schedule to be deleted
	 *
	 * @return boolean true on success otherwise false
	 */
	public function deleteSingle($scheduleID)
	{
		$schedule = JTable::getInstance('schedules', 'thm_organizerTable');
		$schedule->load($scheduleID);

		return $schedule->delete();
	}

	/**
	 * Gets a schedule row for referencing. Implicitly migrating as necessary
	 *
	 * @param bool $save             whether or not the migrated schedule should be saved to the corresponding db tables
	 * @param int  $departmentID     the department id of the reference row
	 * @param int  $planningPeriodID the planning period id of the reference row
	 * @param bool $rewind           whether a previous schedule should be loaded for comparison purposes
	 *
	 * @return  mixed  object if successful, otherwise null
	 */
	private function getScheduleRow($save = false, $departmentID = null, $planningPeriodID = null, $rewind = null)
	{
		$scheduleRow = JTable::getInstance('schedules', 'thm_organizerTable');

		if (empty($departmentID) OR empty($planningPeriodID))
		{
			$referenceIDs = JFactory::getApplication()->input->get('cid', array(), 'array');
			$pullData = $referenceIDs[0];
		}

		// Active schedule row
		else
		{
			$pullData = array(
				'departmentID'     => $departmentID,
				'planningPeriodID' => $planningPeriodID,
				'active'           => 1
			);
		}

		$exists = $scheduleRow->load($pullData);

		if (!$exists)
		{
			return null;
		}

		if (empty($scheduleRow->newSchedule))
		{
			$migrated = $this->migrate($scheduleRow->id, $save);

			if (!$migrated)
			{
				return null;
			}

			// Ensures that the changes performed during the migration process are loaded.
			$scheduleRow->load($scheduleRow->id);
		}

		return $scheduleRow;
	}

	/**
	 * Migrates an existing deprecated format schedule to a schedule with the new format
	 *
	 * @param int  $scheduleID the id of the schedule if called implicitly
	 * @param bool $save       whether or not the migrated schedule (if active) should be saved to the db
	 *
	 * @return   array  $statusReport  ['scheduleID']  true on save, false on db error
	 *                                 ['errors']      critical data inconsistencies
	 *                                 ['warnings']    minor data inconsistencies
	 */
	public function migrate($scheduleID = null, $save = false)
	{
		// Called directly by schedule manager view
		if (empty($scheduleID))
		{
			$input       = JFactory::getApplication()->input;
			$scheduleIDs = $input->get('cid', array(), 'array');

			if (empty($scheduleIDs))
			{
				$scheduleID = $input->getInt('id');
				if (empty($scheduleID))
				{
					return false;
				}
				$scheduleIDs = array($scheduleID);
			}
		}

		// Called implicitly in this class
		else
		{
			$scheduleIDs = array($scheduleID);
		}

		foreach ($scheduleIDs as $scheduleID)
		{
			$jsonModel = new THM_OrganizerModelJSONSchedule;
			$success   = $jsonModel->migrate($scheduleID, $save);

			// End on first fail
			if (!$success)
			{
				return false;
			}
		}

		// TODO: Add explicit joomla messages

		return true;
	}

	/**
	 * Creates the delta to the chosen reference schedule
	 *
	 * @return boolean true on successful delta creation, otherwise false
	 */
	public function setReference()
	{
		$save      = false;
		$reference = $this->getScheduleRow($save);
		if (empty($reference) OR empty($reference->id))
		{
			return true;
		}

		$active = $this->getScheduleRow($save, $reference->departmentID, $reference->planningPeriodID);
		if (empty($active) OR empty($active->id))
		{
			return true;
		}

		$oldJsonModel  = new THM_OrganizerModelOldJSONSchedule;
		$oldRefSuccess = $oldJsonModel->setReference($reference, $active);

		if (!$oldRefSuccess)
		{
			return false;
		}

		// Free up memory
		unset($oldJsonModel);

		$jsonModel  = new THM_OrganizerModelJSONSchedule;
		$refSuccess = $jsonModel->setReference($reference, $active);

		return $refSuccess;
	}

	/**
	 * Toggles the schedule's active status
	 *
	 * @return  boolean  true on success, otherwise false
	 */
	public function toggle()
	{
		$input      = JFactory::getApplication()->input;
		$scheduleID = $input->getInt('id', 0);
		if (empty($scheduleID))
		{
			return false;
		}

		$value = $input->getInt('value', 1);
		if ($value)
		{
			return $this->deactivate($scheduleID);
		}

		return $this->activate($scheduleID);
	}

	/**
	 * saves a schedule in the database for later use
	 *
	 * @return   array  $statusReport  ['scheduleID']  true on save, false on db error
	 *                                 ['errors']      critical data inconsistencies
	 *                                 ['warnings']    minor data inconsistencies
	 */
	public function upload()
	{
		$xmlModel = new THM_OrganizerModelXMLSchedule();
		$valid    = $xmlModel->validate();

		if (!$valid)
		{
			return false;
		}

		$this->schedule = $xmlModel->schedule;
		$this->newSchedule = $xmlModel->newSchedule;

		$new = JTable::getInstance('schedules', 'thm_organizerTable');
		$new->set('departmentID', $this->schedule->departmentID);
		$new->set('departmentname', $this->schedule->departmentname);
		$new->set('planningPeriodID', $this->schedule->planningPeriodID);
		$new->set('semestername', $this->schedule->semestername);
		$new->set('creationDate', $this->schedule->creationDate);
		$new->set('creationTime', $this->schedule->creationTime);
		$new->set('startDate', $this->schedule->startDate);
		$new->set('endDate', $this->schedule->endDate);
		$new->set('schedule', json_encode($this->schedule));
		$new->set('newSchedule', json_encode($this->newSchedule));
		$new->store();

		$reference = $this->getScheduleRow(false, $new->departmentID, $new->planningPeriodID);

		if (empty($reference) OR empty($reference->id))
		{
			$new->set('active', 1);
			$new->store();
			return true;
		}

		$oldJsonModel  = new THM_OrganizerModelOldJSONSchedule;
		$oldRefSuccess = $oldJsonModel->setReference($reference, $new);

		if (!$oldRefSuccess)
		{
			return false;
		}

		// Free up memory
		unset($oldJsonModel);

		$jsonModel  = new THM_OrganizerModelJSONSchedule;
		return $jsonModel->setReference($reference, $new);
	}
}
